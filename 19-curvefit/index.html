<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2018-09-07 10:30:57 -0400">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - PHY224 Python Review"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="/assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="/assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="/assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="/assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>PHY224 Python Review: Fitting data to models</title>
  </head>
  <body>
    <div class="container">
      
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

        
	
        <li><a href="../setup/">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-run-quit/index.html">Running and Quitting</a></li>
            
            <li><a href="../02-variables/index.html">Variables and Assignment</a></li>
            
            <li><a href="../03-types-conversion/index.html">Data Types and Type Conversion</a></li>
            
            <li><a href="../04-built-in/index.html">Built-in Functions and Help</a></li>
            
            <li><a href="../06-libraries/index.html">Libraries</a></li>
            
            <li><a href="../07-numpy/index.html">Numpy and Scipy</a></li>
            
            <li><a href="../08-reading-tabular/index.html">Reading Tabular Data into arrays</a></li>
            
            <li><a href="../09-plotting/index.html">Plotting</a></li>
            
            <li><a href="../11-lists/index.html">Lists</a></li>
            
            <li><a href="../12-for-loops/index.html">For Loops</a></li>
            
            <li><a href="../13-looping-data-sets/index.html">Looping Over Data Sets</a></li>
            
            <li><a href="../14-writing-functions/index.html">Writing Functions</a></li>
            
            <li><a href="../15-scope/index.html">Variable Scope</a></li>
            
            <li><a href="../17-conditionals/index.html">Conditionals</a></li>
            
            <li><a href="../18-style/index.html">Programming Style</a></li>
            
            <li><a href="../19-curvefit/index.html">Fitting data to models</a></li>
            
            <li><a href="../20-wrap/index.html">Wrap-Up</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio.html">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
	

	
        <li><a href="../LICENSE.html">License</a></li>
	    </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>


<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../18-style/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">PHY224 Python Review</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../20-wrap/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Fitting data to models</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 50 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do I fit my data to a scientific model.</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Import the scipy.optimize library.</p>
</li>
	
	<li><p>Understand the curvefit function.</p>
</li>
	
	<li><p>Print the results from curvefit.</p>
</li>
	
	<li><p>Plot the data from curvefit.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h2 id="data-analysis-with-python">Data analysis with Python</h2>

<p>Many physical systems can be modeled as an equation, which in Python would be represented by a function <em>f</em> . If an appropriate function <em>f</em> can be found for an experiment we can use the equation to determine physical parameters releted to the experiment, and we can use this new model to <em>predict</em> new things about the world. Galileo used this method to calculate the trajectory of canonballs by rolling them down inclined ramps.</p>

<p>In experimental physics, we constrain these models by designing an experiment with two quantities. The first quantity, that we can control, is the <strong>independent variable</strong>. The second quantity, that we can measure, is the <strong>dependent variable</strong>.  The relationship between these two quantities can then be used to determine some physical parameters.</p>

<p>A simple example of measuring the path of moving object. We could guess that the model is moving at a constant speed and design an experiment to find that speed using the model:</p>

<script type="math/tex; mode=display">s = ut</script>

<h2 id="scipy-provides-functions-that-can-fit-model-functions-to-data">Scipy provides functions that can fit model functions to data.</h2>

<p><code class="highlighter-rouge">Scipy</code> provides a number of functions that, given a suitable model function, can return the <em>best estimate</em> of the unknown parameters in the model.</p>

<p>Consider the experiment where the time of flight of an object moving at constant speed is measured. If the experiment is correctly setup. The unknown variable we are trying to determine is the speed <em>u</em>. The remaining variables are time <em>t</em> and height <em>s</em>. We can design two different experiments, one where we control <em>time</em> (measuring at a fixed interval) and measure <em>distance</em>, or one where we control <em>distance</em> and measure <em>time</em>.</p>

<p>In Python the model function might be written as:</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def distance(time, speed):
    """Calculate the distance travelled at a constant speed for a known time."""
    return speed * time

def model_function(independent_data, parameter1, parameter2):
    """A template for the model function."""
    dependent_data = parameter1 * independent_data + parameter2
    return dependent_data
</code></pre></div></div>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code># control time, measure distance
import numpy
# derr is my estimate of errors measuring distance, my ruler is bad.
derr = 5 # metres

measured_times =numpy.arange(10,100,10) #time in seconds
measured_distances = numpy.array([ 108.2,  220.4,  360.2,  482.8,
        630.6,  793.9,  947.5, 1125.0, 1314.9]) # distance in metres
distance_errors = numpy.ones_like(measured_distances)*derr
</code></pre></div></div>

<p>For such a simple model, the average speed can be calculated from the data quite easily.</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speeds = measured_distances / measured_times
average_speed = numpy.average(speeds)
print("Average speed is {:.04g} m/s".format(average_speed))
mean_times_error = numpy.std(speeds, ddof=1)/numpy.sqrt(speeds.size)
mean_times_std = numpy.sqrt( numpy.mean( derr**2 * numpy.ones(speeds.size)) )

#error propagation, sum in quadrature
speed_error = numpy.sqrt( numpy.mean( (distance_errors / measured_distances)**2) )* average_speed
print("Standard error in average speed is {:.03g} m/s".format(mean_times_error))
print("Error in average speed is {:.03g} m/s".format(speed_error))
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average speed is 12.66 m/s
Standard error in average speed is 0.437 m/s
Error in average speed is 0.236 m/s
</code></pre></div></div>

<ul>
  <li>You can also use <code class="highlighter-rouge">scipy.optimize.curve_fit</code> to perform this calculation.</li>
</ul>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from scipy.optimize import curve_fit

popt, pcov = curve_fit(distance, measured_times, measured_distances)

print("Speed is %4g m/s" % popt[0])

pvar = numpy.diag(pcov)
print("Error in fitted speed is {:.03g} m/s".format(numpy.sqrt(pvar[0])))
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Speed is 13.6644 m/s
Error in fitted speed is 0.31 m/s
</code></pre></div></div>

<h2 id="what-is-popt-pvar">What is <code class="highlighter-rouge">popt</code>, <code class="highlighter-rouge">pvar</code>?</h2>

<ul>
  <li><code class="highlighter-rouge">popt</code> is a one dimensional array of the best estimates for the parameter values, each entry matches the order in the function definition</li>
  <li>
    <p><code class="highlighter-rouge">pcov</code> is the covariance matrix showing the uncertainty and interdependence of each parameter in <code class="highlighter-rouge">popt</code>. We take the diagonal elements as <code class="highlighter-rouge">pvar</code> for the variance of each parameter in <code class="highlighter-rouge">popt</code>.</p>
  </li>
  <li>The above error didn’t consider the errors in the individual data points correctly.</li>
  <li>Give <code class="highlighter-rouge">curve_fit</code> the error values using the <code class="highlighter-rouge">sigma</code> keyword, and always use <code class="highlighter-rouge">absolute_sigma=True</code></li>
</ul>

<blockquote class="challenge">
  <h2 id="exercise-1">Exercise 1</h2>

  <p>Predict the value of distance after 10 seconds and 100s.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>
    <h3 id="calculate-predictions-using-the-model-function">Calculate predictions using the model function</h3>
    <ul>
      <li><code class="highlighter-rouge">curve_fit</code> needs a model function to make predictions.</li>
      <li>Any calculations using that model should also use the function to avoid errors</li>
      <li>e.g. when plotting the predictions you should call the model_function, <em>and not rewrite the equation</em></li>
    </ul>

    <div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Always predict with the model function!
d10 = distance(10, popt[0])
d100 = distance(100, popt[0])
print("After 10 seconds, predicted distance = {:.4g}m".format(d10))
print("After 100 seconds, predicted distance = {:.4g}m".format(d100))

#dont_do_this
rewrite10 = popt[0] * 10
print("After 10 seconds, predicted distance = {:.4g}m".format(rewrite10))

#or this
hardcoded10 = 13.64 * 10
print("After 10 seconds, predicted distance = {:.4g}m".format(hardcoded10))
</code></pre></div>    </div>
    <div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>After 10 seconds, predicted distance = 136.6m
After 100 seconds, predicted distance = 1366m
After 10 seconds, predicted distance = 136.6m
After 10 seconds, predicted distance = 136.4m
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>popt, pcov = curve_fit(distance, measured_times, measured_distances,
                       absolute_sigma=True, sigma = distance_errors)
pvar = numpy.diag(pcov)

print("Average speed is {:.04g} m/s".format(popt[0]))
print("Error in fitted speed is {:.03g} m/s".format(numpy.sqrt(pvar[0])))
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average speed is 13.66 m/s
Error in fitted speed is 0.0296 m/s
</code></pre></div></div>

<ul>
  <li>With the correct error estimates, the model is more certain about the speed, but the eastimate of the average speed didn’t change.</li>
</ul>

<h2 id="the-model-function-needs-to-follow-the-curve_fit-rules">The model function needs to follow the <code class="highlighter-rouge">curve_fit</code> rules</h2>
<ul>
  <li>The function must take and array of <strong>independent data</strong> as its first argument</li>
  <li>The function can take any number of additional parameters that will be found using <code class="highlighter-rouge">curve_fit</code></li>
  <li>The function must return a single prediction of the <strong>dependent data</strong> for each value in the independent data.</li>
</ul>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def good_model_function(xdata, parameter_1, parameter_2, parameter_3):
    # code_that_calculates_a_model
    return prediction
</code></pre></div></div>

<h2 id="curve_fit-works-with-multiple-parameters"><code class="highlighter-rouge">curve_fit</code> works with multiple parameters</h2>

<p>Extending the above experiment, what if the object was actually accelerating? The model function is now</p>

<script type="math/tex; mode=display">s = ut + \frac{1}{2} at^2</script>

<p>where $a$ is the acceleration. We can change the model function and run the <code class="highlighter-rouge">curve_fit</code> code again</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def distance_with_acceleration(time, speed, acceleration):
    """Calculate the distance travelled with at a constant speed for a known time
    and constant acceleration."""
    return speed * time + 0.5 * acceleration * time**2

from scipy.optimize import curve_fit
popt2, pcov2 = curve_fit(distance_with_acceleration, measured_times, measured_distances,
                       absolute_sigma=True, sigma = distance_errors)
print("Initial speed is {:.04g} m/s".format(popt2[0]))
print("Error in fitted initial speed is {:.03g} m/s".format(numpy.sqrt(pcov2[0,0])))

print("Acceleration is {:.04g} m/s2".format(popt2[1]))
print("Error in fitted acceleration is {:.03g} m/s2".format(numpy.sqrt(pcov2[1,1])))
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Initial speed is 10.26 m/s
Error in fitted initial speed is 0.119 m/s
Acceleration is 0.09596 m/s2
Error in fitted acceleration is 0.00325 m/s2
</code></pre></div></div>

<p>The data used here is simulated, generated with an initial speed of 10.86 m/s and an acceleration of 0.1m/s<sup>2</sup>. The model with constant speed predicted a higher speed to compensate for the acceleration!</p>

<h2 id="exercise-1-1">Exercise 1</h2>
<p>How could we have quickly checked whether our model was good?</p>

<p>A <strong>plot</strong> would have quickly showed the linear model is not correct, or printing each value predicted might tell us something too for small amounts of data.</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%matplotlib inline
import matplotlib.pyplot as plt
plt.style.use("seaborn-whitegrid")
plt.figure(figsize=(8,6))
plt.errorbar(measured_times, measured_distances,yerr=distance_errors, marker='o', linestyle='none', label="measured data")
plt.plot(measured_times, distance(measured_times, numpy.mean(speeds)),label='simple average')
plt.plot(measured_times, distance(measured_times, popt[0]),label='$s=ut$')
plt.plot(measured_times, distance_with_acceleration(measured_times, popt2[0],popt2[1]),label=r'$s=ut+\frac{1}{2}at^2$')
plt.legend(fontsize=14)
plt.xlabel("Time (s)")
plt.ylabel("Distance (m)")
</code></pre></div></div>

<p><img src="../fig/19_24_1.png" alt="png" /></p>

<p><strong>Always plot your data and model fits.</strong></p>

<h2 id="curve_fit-finds-the-best-estimate-of-the-parameters-using-by-minimizing-chi-squared"><code class="highlighter-rouge">curve_fit</code> finds the <em>best estimate</em> of the parameters using by minimizing <em>chi squared</em>.</h2>
<ul>
  <li>Curve fit works by finding the combination of parameters that gives the lowest value of a parameter χ<sup>2</sup>, defined as</li>
</ul>

<script type="math/tex; mode=display">\chi^2 = \sum\frac{(y_i - f(x_i))^2}{\sigma_{y_i}^2}</script>

<ul>
  <li>The lower the value of this metric, the closer the model is <strong>on average</strong> to each measured data point.</li>
  <li>This metric penalizes outliers disproportionally because of the square factor</li>
  <li>The metric weights the penalty of each point by the inverse of the standard deviation, penalizing (genuinely) noisier outliers less than less noisy outliers.</li>
</ul>

<h2 id="reduced-chi-squared-is-easier-to-understand-and-compare-between-data-sets"><em>Reduced chi squared</em> is easier to understand and compare between data sets.</h2>
<ul>
  <li>The value of χ<sup>2</sup> for a model depends on the number of data points and model parameters.</li>
  <li>A related variable <script type="math/tex">\chi_r^2 = \frac{\chi^2}{\mathrm{dof}}</script> is defined such that a the ideal value is 1.0.</li>
  <li>
    <p>To get the metric we need the number of <strong>degrees of freedom</strong> (dof) defined as the number of data points (N) minus the number of unknown parameters (m) <script type="math/tex">\mathrm{dof} = N - m</script>.</p>
  </li>
  <li>High values of χ<sup>2</sup> are bad and suggest the model does a poor job of fitting the data.</li>
  <li>Low values (&lt;&lt;1) are also bad, suggesting the model fits the data <strong>too well</strong>.</li>
  <li>A low value suggests the model is fitting data better than the average error in the data should allow.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">chi2</span><span class="p">(</span><span class="n">y_measure</span><span class="p">,</span><span class="n">y_predict</span><span class="p">,</span><span class="n">errors</span><span class="p">):</span>
    <span class="s">"""Calculate the chi squared value given a measurement with errors and prediction"""</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">y_measure</span> <span class="o">-</span> <span class="n">y_predict</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">errors</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">chi2reduced</span><span class="p">(</span><span class="n">y_measure</span><span class="p">,</span> <span class="n">y_predict</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">number_of_parameters</span><span class="p">):</span>
    <span class="s">"""Calculate the reduced chi squared value given a measurement with errors and prediction,
    and knowing the number of parameters in the model."""</span>
    <span class="k">return</span> <span class="n">chi2</span><span class="p">(</span><span class="n">y_measure</span><span class="p">,</span> <span class="n">y_predict</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">y_measure</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">number_of_parameters</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Constant velocity model chi2r="</span><span class="p">,</span><span class="n">chi2reduced</span><span class="p">(</span><span class="n">measured_distances</span><span class="p">,</span> 
                                        <span class="n">distance</span><span class="p">(</span><span class="n">measured_times</span><span class="p">,</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="n">distance_errors</span><span class="p">,</span>
                                        <span class="mi">1</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Constant acceleration model chi2r="</span><span class="p">,</span><span class="n">chi2reduced</span><span class="p">(</span><span class="n">measured_distances</span><span class="p">,</span> 
                                        <span class="n">distance_with_acceleration</span><span class="p">(</span><span class="n">measured_times</span><span class="p">,</span><span class="n">popt2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">popt2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                        <span class="n">distance_errors</span><span class="p">,</span>
                                        <span class="mi">2</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Constant velocity model chi2r= 109.80241339312079
Constant acceleration model chi2r= 1.1868575297735016
</code></pre></div></div>

<h2 id="exercise-2">Exercise 2</h2>
<p>Put a print statement inside the model function <code class="highlighter-rouge">distance_with_acceleration</code> to print out the parameter values. What is happening to the parameter values?</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def distance_with_acceleration_print(time, speed, acceleration):
    """Calculate the distance travelled with at a constant speed for a known time
    and constant acceleration."""
    
    print ("speed=",speed, "acceleration=",acceleration)
    return speed * time + 0.5 * acceleration * time**2

popt2, pcov2 = curve_fit(distance_with_acceleration_print, measured_times, measured_distances,
                       absolute_sigma=True, sigma = distance_errors)

</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speed= 1.0 acceleration= 1.0
speed= 1.0 acceleration= 1.0
speed= 1.0 acceleration= 1.0
speed= 1.0000000149011612 acceleration= 1.0
speed= 1.0 acceleration= 1.0000000149011612
speed= 10.255137832154007 acceleration= 0.0959638771711041
speed= 10.255137984967469 acceleration= 0.0959638771711041
speed= 10.255137832154007 acceleration= 0.09596387860107732
speed= 10.255137840593912 acceleration= 0.09596387693800011
</code></pre></div></div>

<h2 id="non-linear-regression">Non-linear regression</h2>
<ul>
  <li>Mathematically, <code class="highlighter-rouge">curve_fit</code> is using <em>least squared error regression</em> to find the best parameter estimate.</li>
  <li><code class="highlighter-rouge">curve_fit</code> works with non linear models, e.g.<script type="math/tex">y=at^{(b-1)}+c</script></li>
</ul>

<h2 id="when-fitting-non-linear-functions-use-the-p0-keyword-to-start-curve_fit-with-a-good-estimate">When fitting non-linear functions, use the <code class="highlighter-rouge">p0</code> keyword to start <code class="highlighter-rouge">curve_fit</code> with a good estimate</h2>
<ul>
  <li><code class="highlighter-rouge">p0</code> is used to provide a first guess of the parameters you are trying to find</li>
  <li>If you have some idea of a parameter value, use <code class="highlighter-rouge">p0</code> to give <code class="highlighter-rouge">curve_fit</code> a better chance of finding the global minimum error for non-linear functions</li>
  <li>Don’t be too precise so as not to bias the fitting process.</li>
</ul>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iteration=0

def nonlinear_function(t, a, b, c):
    global iteration
    print (iteration, "a=",a, "b=",b, "c=",c)
    iteration = iteration+1
    return a*t**(b-1) + c

#generated "good" data
t=numpy.arange(10)
y=numpy.array([-0.173, 2.12, 9.42, 19.69, 37.16, 59.40, 96.59, 119.448, 158.0,201.9])
sigmaNL = numpy.ones(10)*0.5
</code></pre></div></div>

<p>First, try fitting the non-linear function with no initial guess</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iteration=0
poptNL1, pcovNL1 = curve_fit(nonlinear_function, t, y,
                       absolute_sigma=True, sigma = sigmaNL)
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 a= 1.0 b= 1.0 c= 1.0
1 a= 1.0 b= 1.0 c= 1.0
2 a= 1.0 b= 1.0 c= 1.0
3 a= 1.0000000149011612 b= 1.0 c= 1.0
4 a= 1.0 b= 1.0000000149011612 c= 1.0
5 a= 1.0 b= 1.0 c= 1.0000000149011612
6 a= 77.19199892187382 b= 1.000001167729559 c= 1.0
7 a= 77.19200007212423 b= 1.000001167729559 c= 1.0
8 a= 77.19199892187382 b= 1.0000011826307376 c= 1.0
...
151 a= 2.507417147966414 b= 2.9990317544021594 c= -0.9734594072738433
152 a= 2.5074171106029874 b= 2.999031799091215 c= -0.9734594072738433
153 a= 2.5074171106029874 b= 2.9990317544021594 c= -0.9734593927681677
154 a= 2.5074210685973637 b= 2.999031031902325 c= -0.9734725519528605
</code></pre></div></div>

<p>Try a good guess for the parameters</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iteration = 0
poptNL2, pcovNL2 = curve_fit(nonlinear_function, t, y,
                       absolute_sigma=True, sigma = sigmaNL, p0=(2.5,3,0))
#I think it's 2.5*t^2 with no offset
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 a= 2.5 b= 3.0 c= 0.0
1 a= 2.5 b= 3.0 c= 0.0
2 a= 2.5 b= 3.0 c= 0.0
3 a= 2.500000037252903 b= 3.0 c= 0.0
4 a= 2.5 b= 3.0000000447034836 c= 0.0
5 a= 2.5 b= 3.0 c= 1.4901161193880158e-08
6 a= 2.507540116653946 b= 2.9990074809599334 c= -0.973917163330992
7 a= 2.5075401540192055 b= 2.9990074809599334 c= -0.973917163330992
8 a= 2.507540116653946 b= 2.9990075256486275 c= -0.973917163330992
9 a= 2.507540116653946 b= 2.9990074809599334 c= -0.9739171488184953
10 a= 2.5074184226341583 b= 2.9990315172382234 c= -0.9734643979860024
11 a= 2.5074184599976044 b= 2.9990315172382234 c= -0.9734643979860024
12 a= 2.5074184226341583 b= 2.9990315619272754 c= -0.9734643979860024
13 a= 2.5074184226341583 b= 2.9990315172382234 c= -0.9734643834802524
14 a= 2.5074209783416057 b= 2.9990310475838156 c= -0.9734720313746336
</code></pre></div></div>

<p>Now try an unreasonable guess for the <code class="highlighter-rouge">b</code> parameter</p>

<div class="python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iteration = 0
poptNL3, pcovNL3 = curve_fit(nonlinear_function, t, y,
                       absolute_sigma=True, sigma = sigmaNL, p0=(3,-2,0.1))
#I think it's 3/t^3 +0.1
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 a= 3.0 b= -2.0 c= 0.1
1 a= 3.0 b= -2.0 c= 0.1
2 a= 3.0 b= -2.0 c= 0.1
3 a= 3.0000000447034836 b= -2.0 c= 0.1
4 a= 3.0 b= -1.9999999701976776 c= 0.1
5 a= 3.0 b= -2.0 c= 0.10000000149011612

/Users/lee/anaconda3/lib/python3.6/site-packages/ipykernel/__main__.py:7: RuntimeWarning: divide by zero encountered in power
/Users/lee/anaconda3/lib/python3.6/site-packages/scipy/optimize/minpack.py:794: OptimizeWarning: Covariance of the parameters could not be estimated category=OptimizeWarning)
</code></pre></div></div>

<p>It’s always important to <strong>check the fit</strong></p>

<p><img src="../fig/19_41_3.png" alt="png" /></p>



<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p><code class="highlighter-rouge">scipy</code> provides tools and functions to fit models to data.</p>
</li>
    
    <li><p>Use <code class="highlighter-rouge">curve_fit</code> to fit linear and non-linear models to experimental data</p>
</li>
    
    <li><p>Use appropriate errors in the <code class="highlighter-rouge">sigma</code> keyword to get a better estimate of parameter errors.</p>
</li>
    
    <li><p>Check the fit using a plot if possible</p>
</li>
    
    <li><p>Check the χ<sup>2</sup> value to compare the fit against the errors in the measurements.</p>
</li>
    
    <li><p>Non linear models can be fitted, but may need an initial esimate of the parameters.</p>
</li>
    
  </ul>
</blockquote>

</article>

<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../18-style/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../20-wrap/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      
<footer>
  <div class="row">
    <div class="col-md-12 copyright" align="left">
    	Portions Copyright 2018 Christopher Lee. <br/>
    	Remainder copyright <a href="https://carpentries.org/">The Carpentries</a>/<a href="https://software-carpentry.org">Software Carpentry Foundation</a> 2016-2018. <br/>Based on Software Carpentry gapminder lessons.
    </div>
</div>
      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
